# ì••êµ¬ì •ë™_ë§¤ë¬¼ì•±_ë‹¨ê³„í˜•.py
# ì‹¤í–‰: streamlit run "ì••êµ¬ì •ë™_ë§¤ë¬¼ì•±_ë‹¨ê³„í˜•.py"

import os, re, time
import numpy as np
import pandas as pd
import streamlit as st
from datetime import datetime
from urllib.parse import quote

st.set_page_config(page_title="ì••êµ¬ì •ë™ ì‹¤ë§¤ë¬¼ Â· ì„ëŒ€ ì‹¤ì‹œê°„ ê²€ìƒ‰ (ë‹¨ê³„í˜•)", page_icon="ğŸ ", layout="wide")
st.title("ğŸ  ì••êµ¬ì •ë™ ì‹¤ë§¤ë¬¼ Â· ì„ëŒ€ ì‹¤ì‹œê°„ ê²€ìƒ‰ (ë‹¨ê³„í˜•)")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0) ë°ì´í„° ì†ŒìŠ¤ (êµ¬ê¸€ì‹œíŠ¸ by sheet name)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SHEET_ID = "1QP56lm5kPBdsUhrgcgY2U-JdmukXIkKCSxefd1QExKE"
CSV_BASE = f"https://docs.google.com/spreadsheets/d/{SHEET_ID}/gviz/tq?tqx=out:csv"

SALE_SHEET_NAME = "ë§¤ë§¤ë¬¼ê±´ ëª©ë¡"
RENT_SHEET_NAME = "ì„ëŒ€ë¬¼ê±´ ëª©ë¡"

# (ì„ íƒ) ë¡œì»¬ ì—‘ì…€ í…ŒìŠ¤íŠ¸ ì‹œ ê²½ë¡œ ì…ë ¥ (ë¹„ì›Œë‘ë©´ ë¬´ì‹œ)
EXCEL_PATH = ""  # ì˜ˆ) r"D:\OneDrive\office work\00 ì••êµ¬ì •ë™ ì‹¤ì‹œê°„ ë§¤ë¬¼ì•±\ì›ë¶€ë™ì‚° ë§¤ë¬¼ì¥.xlsx"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ìœ í‹¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def parse_first_number(val):
    s = str(val)
    if s.strip() == "" or s.lower() == "nan":
        return float('nan')
    m = re.findall(r"\d+\.?\d*", s.replace(",", ""))
    return float(m[0]) if m else float('nan')

def normalize_columns(df: pd.DataFrame) -> pd.DataFrame:
    """ì‹œíŠ¸ ì»¬ëŸ¼ ë³€ê²½ì—ë„ ê²¬ë”œ ìˆ˜ ìˆê²Œ ê¸°ë³¸ ë³„ì¹­ ë§¤í•‘ (í‰í˜•ëŒ€ëŠ” ìˆëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©)."""
    df = df.copy()
    df.columns = (df.columns.astype(str)
                  .str.replace('\u00a0', ' ', regex=False)  # NBSP
                  .str.replace('\ufeff', '', regex=False)   # BOM
                  .str.strip())
    alias, cols = {}, df.columns.tolist()

    for c in cols:
        c0 = c.strip()
        lc = c0.lower()

        # ê³µí†µ
        if "ê³µê°œ" in c0: alias[c0] = "ê³µê°œì—¬ë¶€"
        if any(k in c0 for k in ["ìš”ì•½","íŠ¹ì§•","ë©”ëª¨","ë¹„ê³ "]) or ("ìš”ì—­" in c0):  # ì˜¤íƒ€ ìš”ì—­ë‚´ìš© êµì •
            alias[c0] = "ìš”ì•½ë‚´ìš©"
        if c0 in ["ì¸µ/í˜¸","ì¸µí˜¸","ì¸µìˆ˜"] and "ì¸µ" not in cols:
            alias[c0] = "ì¸µ"
        if "êµ¬ì—­" in c0 and "êµ¬ì—­" not in cols:
            alias[c0] = "êµ¬ì—­"
        if c0 in ["ë™í˜¸ìˆ˜"] and "ë™" not in cols:
            alias[c0] = "ë™"

        # ë§¤ë§¤ ê¸ˆì•¡(ë§Œì›) ê³„ì—´ â†’ ê°€ê²©(ë§Œì›)
        if (("ë§¤ë§¤" in c0 or "ê°€ê²©" in c0) and "ë§Œì›" in c0) and "ê°€ê²©(ë§Œì›)" not in alias.values():
            alias[c0] = "ê°€ê²©(ë§Œì›)"

        # ì„ëŒ€ ì „ì„¸ê¸ˆ(=ê¸ˆì•¡(ì–µ)) ë³„ì¹­
        if any(k in c0 for k in ["ì „ì„¸ê¸ˆ","ì „ì„¸ê°€","ì „ì„¸"]) and ("ì–µ" in c0):
            alias[c0] = "ê¸ˆì•¡(ì–µ)"
        if c0 in ["ê°€ê²©(ì–µ)","ì„ëŒ€ê¸ˆì•¡(ì–µ)","ì „ì„¸(ì–µ)"]:
            alias[c0] = "ê¸ˆì•¡(ì–µ)"

        # ì„ëŒ€ ë³´ì¦ê¸ˆ/ì›”ì„¸ (ë§Œì›/ì–µ í˜¼ì¬ ëŒ€ì‘)
        if "ë³´ì¦ê¸ˆ" in c0 and "ì–µ" in c0:
            alias[c0] = "ë³´ì¦ê¸ˆ(ì–µ)"
        if "ë³´ì¦ê¸ˆ" in c0 and ("ë§Œ" in c0 or "ë§Œì›" in c0):
            alias[c0] = "ë³´ì¦ê¸ˆ(ë§Œì›)"
        if ("ì›”ì„¸" in c0) and (("ë§Œ" in c0) or ("ë§Œì›" in c0) or c0 == "ì›”ì„¸"):
            alias[c0] = "ì›”ì„¸(ë§Œ)"

        # í‰í˜•ëŒ€ ì»¬ëŸ¼(ë¬¸ìì—´)ì€ ìˆëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ ë³„ì¹­ë§Œ ìµœì†Œí™”
        if "í‰í˜•ëŒ€" in c0.replace(" ", "") and "í‰í˜•ëŒ€" not in df.columns:
            alias[c0] = "í‰í˜•ëŒ€"

        # í‰í˜•(ë¬¸ìì—´) ë³„ì¹­
        if "í‰í˜•" not in cols and c0.replace(" ", "") in ["í‰í˜•(í‰)","í‰ìˆ˜","ì „ìš©(í‰)","ì „ìš©í‰","ì „ìš©ë©´ì (í‰)"]:
            alias[c0] = "í‰í˜•"
        elif "í‰í˜•" not in cols and ("í‰" in c0.replace(" ", "")) and ("í‰í˜•ëŒ€" not in c0) and ("í‰ë‹¹" not in c0) and ("ê°€ê²©" not in c0):
            alias[c0] = "í‰í˜•"

    if alias:
        df = df.rename(columns=alias)

    # í•„ìˆ˜ í…ìŠ¤íŠ¸ ì»¬ëŸ¼ ë³´ê°•
    for c in ["êµ¬ì—­","ë™","ì¸µ","ìš”ì•½ë‚´ìš©","í‰í˜•","í‰í˜•ëŒ€"]:
        if c not in df.columns:
            df[c] = ""

    return df

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ì „ì²˜ë¦¬ (ë§¤ë§¤/ì„ëŒ€)  â€” í‰í˜•ëŒ€ëŠ” ì‹œíŠ¸ ê°’ì„ ê·¸ëŒ€ë¡œ ì‹ ë¢°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def enrich_sale(df: pd.DataFrame) -> pd.DataFrame:
    df = normalize_columns(df)

    # ê¸ˆì•¡(ì–µ)
    price_col = next((c for c in ["ë§¤ë§¤ê°€(ë§Œì›)","ê°€ê²©(ë§Œì›)","ë§¤ë§¤(ë§Œì›)","ê±°ë˜ê¸ˆì•¡(ë§Œì›)","ê¸ˆì•¡(ë§Œì›)"] if c in df.columns), None)
    if "ê¸ˆì•¡(ì–µ)" in df.columns:
        df["ê¸ˆì•¡(ì–µ)"] = pd.to_numeric(df["ê¸ˆì•¡(ì–µ)"].apply(parse_first_number), errors="coerce")
    elif price_col:
        df[price_col] = df[price_col].apply(parse_first_number)
        df["ê¸ˆì•¡(ì–µ)"] = (df[price_col]/10000).round(1)
    else:
        df["ê¸ˆì•¡(ì–µ)"] = np.nan

    # í‰í˜•/í‰í˜•ëŒ€ í‘œì¤€í™”(ê³µë°± ì œê±°)
    df["í‰í˜•"] = df["í‰í˜•"].astype(str).str.strip()
    df["í‰í˜•ëŒ€"] = df["í‰í˜•ëŒ€"].astype(str).str.replace(" ", "").str.strip()

    # êµ¬ì—­ ì •ë¦¬
    def normalize_zone(z):
        s = str(z).strip()
        if s == "" or s.lower() == "nan": return ""
        if s.isdigit(): return f"{int(s)}êµ¬ì—­"
        m = re.match(r"(\d+)\s*êµ¬ì—­", s)
        return f"{int(m.group(1))}êµ¬ì—­" if m else s
    df["êµ¬ì—­"] = df["êµ¬ì—­"].apply(normalize_zone)

    # ë™ ìˆ«ìí™” ì‹œë„
    try:
        df["ë™"] = df["ë™"].apply(lambda x: str(int(float(str(x)))) if str(x).replace('.','',1).isdigit() else str(x))
    except Exception:
        df["ë™"] = df["ë™"].astype(str)

    # ê³µê°œì—¬ë¶€
    if "ê³µê°œì—¬ë¶€" in df.columns:
        df["ê³µê°œì—¬ë¶€_norm"] = df["ê³µê°œì—¬ë¶€"].astype(str).str.strip().str.lower().map(
            {"y":"y","yes":"y","true":"y","1":"y","ê³µê°œ":"y"}).fillna("n")
    else:
        df["ê³µê°œì—¬ë¶€_norm"] = "y"

    # ìš”ì•½ ê¸°ë³¸ê°’
    df["ìš”ì•½ë‚´ìš©"] = df["ìš”ì•½ë‚´ìš©"].fillna("").apply(lambda x: "ìƒíƒœ ë³´í†µ" if str(x).strip()=="" else x)
    return df

def enrich_rent(df: pd.DataFrame) -> pd.DataFrame:
    df = normalize_columns(df)

    # ì „ì„¸: ê¸ˆì•¡(ì–µ)
    if "ê¸ˆì•¡(ì–µ)" in df.columns:
        df["ê¸ˆì•¡(ì–µ)"] = pd.to_numeric(df["ê¸ˆì•¡(ì–µ)"].apply(parse_first_number), errors="coerce")
    else:
        won_cols = [c for c in df.columns if ("ê¸ˆì•¡" in c and "ë§Œì›" in c)]
        if won_cols:
            base = won_cols[0]
            df["ê¸ˆì•¡(ì–µ)"] = pd.to_numeric(df[base].apply(parse_first_number), errors="coerce")/10000
        else:
            df["ê¸ˆì•¡(ì–µ)"] = np.nan

    # ë³´ì¦ê¸ˆ(ì–µ) / ì›”ì„¸(ë§Œ)
    if "ë³´ì¦ê¸ˆ(ì–µ)" in df.columns:
        df["ë³´ì¦ê¸ˆ(ì–µ)"] = pd.to_numeric(df["ë³´ì¦ê¸ˆ(ì–µ)"].apply(parse_first_number), errors="coerce")
    else:
        dep_col = next((c for c in ["ë³´ì¦ê¸ˆ(ë§Œì›)","ë³´ì¦ê¸ˆ(ë§Œ)"] if c in df.columns), None)
        if dep_col:
            df["ë³´ì¦ê¸ˆ(ì–µ)"] = pd.to_numeric(df[dep_col].apply(parse_first_number), errors="coerce")/10000
        else:
            df["ë³´ì¦ê¸ˆ(ì–µ)"] = np.nan

    if "ì›”ì„¸(ë§Œ)" in df.columns:
        df["ì›”ì„¸(ë§Œ)"] = pd.to_numeric(df["ì›”ì„¸(ë§Œ)"].apply(parse_first_number), errors="coerce")
    else:
        if "ì›”ì„¸" in df.columns:
            df["ì›”ì„¸(ë§Œ)"] = pd.to_numeric(df["ì›”ì„¸"].apply(parse_first_number), errors="coerce")
        else:
            df["ì›”ì„¸(ë§Œ)"] = np.nan

    # í‰í˜•/í‰í˜•ëŒ€ í‘œì¤€í™”(ê³µë°± ì œê±°)
    df["í‰í˜•"] = df["í‰í˜•"].astype(str).str.strip()
    df["í‰í˜•ëŒ€"] = df["í‰í˜•ëŒ€"].astype(str).str.replace(" ", "").str.strip()

    # êµ¬ì—­/ë™ ì •ë¦¬
    def normalize_zone(z):
        s = str(z).strip()
        if s == "" or s.lower() == "nan": return ""
        if s.isdigit(): return f"{int(s)}êµ¬ì—­"
        m = re.match(r"(\d+)\s*êµ¬ì—­", s)
        return f"{int(m.group(1))}êµ¬ì—­" if m else s
    df["êµ¬ì—­"] = df["êµ¬ì—­"].apply(normalize_zone)

    try:
        df["ë™"] = df["ë™"].apply(lambda x: str(int(float(str(x)))) if str(x).replace('.','',1).isdigit() else str(x))
    except Exception:
        df["ë™"] = df["ë™"].astype(str)

    # ê³µê°œì—¬ë¶€
    if "ê³µê°œì—¬ë¶€" in df.columns:
        df["ê³µê°œì—¬ë¶€_norm"] = df["ê³µê°œì—¬ë¶€"].astype(str).str.strip().str.lower().map(
            {"y":"y","yes":"y","true":"y","1":"y","ê³µê°œ":"y"}).fillna("n")
    else:
        df["ê³µê°œì—¬ë¶€_norm"] = "y"

    # ìš”ì•½ ê¸°ë³¸ê°’
    df["ìš”ì•½ë‚´ìš©"] = df["ìš”ì•½ë‚´ìš©"].fillna("").apply(lambda x: "ìƒíƒœ ë³´í†µ" if str(x).strip()=="" else x)
    return df

@st.cache_data(ttl=60)
def load_sheet(sheet_name: str, kind: str, nonce: int | None = None):
    """kind: 'sale' or 'rent'"""
    url = f"{CSV_BASE}&sheet={quote(sheet_name)}"
    if nonce is not None:
        url += f"&cacheBust={nonce}"  # ìºì‹œ ë¬´ë ¥í™”
    try:
        df = pd.read_csv(url)
        if kind == "sale":
            return enrich_sale(df), f"csv:{sheet_name}"
        else:
            return enrich_rent(df), f"csv:{sheet_name}"
    except Exception as e:
        st.warning(f"{sheet_name} ì‹œíŠ¸ë¥¼ CSVë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: {e}. ì—‘ì…€ë¡œ ì‹œë„í•©ë‹ˆë‹¤.")

    if EXCEL_PATH:
        if not os.path.exists(EXCEL_PATH):
            st.error(f"ì—‘ì…€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {EXCEL_PATH}"); st.stop()
        try:
            df = pd.read_excel(EXCEL_PATH, sheet_name=sheet_name)
            if kind == "sale":
                return enrich_sale(df), f"excel:{sheet_name}"
            else:
                return enrich_rent(df), f"excel:{sheet_name}"
        except Exception as e:
            st.error(f"ì—‘ì…€ '{sheet_name}' ë¡œë“œ ì‹¤íŒ¨: {e}"); st.stop()

    st.error(f"ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ '{sheet_name}' ì ‘ê·¼ ê¶Œí•œ/ì´ë¦„ì„ í™•ì¸í•˜ì„¸ìš”."); st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ë³´ê¸°(ëª¨ë°”ì¼/ë°ìŠ¤í¬í†±) + ìµœìƒìœ„ êµ¬ë¶„(ë§¤ë§¤/ì„ëŒ€) + ê°•ì œ ìƒˆë¡œê³ ì¹¨
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.sidebar.header("ë³´ê¸° ì„¤ì •")
view_mode = st.sidebar.selectbox("ë³´ê¸° ëª¨ë“œ", ["ëª¨ë°”ì¼(ì¹´ë“œ)", "ë°ìŠ¤í¬í†±(í…Œì´ë¸”)"], index=0)
page_size_label = st.sidebar.selectbox("í‘œì‹œ ê°œìˆ˜", ["ì „ì²´", 25, 50, 100], index=0)

if "refresh_nonce" not in st.session_state:
    st.session_state["refresh_nonce"] = None
if st.sidebar.button("ğŸ”„ ì‹œíŠ¸ ë‹¤ì‹œ ì½ê¸° / ìºì‹œ ë¹„ìš°ê¸°"):
    st.cache_data.clear()
    st.session_state["refresh_nonce"] = int(time.time())
    st.experimental_rerun()

if "dataset" not in st.session_state: st.session_state.dataset = None  # 'sale' or 'rent'
if "mode" not in st.session_state: st.session_state.mode = None
if "results_ready" not in st.session_state: st.session_state.results_ready = False
if "page" not in st.session_state: st.session_state.page = 1

def reset_all():
    st.session_state.dataset = None
    st.session_state.mode = None
    st.session_state.results_ready = False
    st.session_state.page = 1

def pick_dataset(d):
    st.session_state.dataset = d
    st.session_state.mode = None
    st.session_state.results_ready = False
    st.session_state.page = 1

def select_mode(m):
    st.session_state.mode = m
    st.session_state.results_ready = False
    st.session_state.page = 1

# ìµœìƒìœ„ ì„ íƒ
with st.container():
    if st.session_state.dataset is None:
        st.subheader("ê²€ìƒ‰ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”")
        c1, c2 = st.columns(2)
        with c1:
            if st.button("ğŸ·ï¸ ë§¤ë§¤ë¬¼ê±´ ê²€ìƒ‰", use_container_width=True): pick_dataset("sale")
        with c2:
            if st.button("ğŸ§¾ ì„ëŒ€ë¬¼ê±´ ê²€ìƒ‰", use_container_width=True): pick_dataset("rent")
    else:
        st.button("â¬…ï¸ ì²˜ìŒìœ¼ë¡œ", on_click=reset_all)

# ë°ì´í„° ë¡œë“œ (ì„ íƒ í›„)
nonce = st.session_state.get("refresh_nonce")
if st.session_state.dataset == "sale":
    df, source_kind = load_sheet(SALE_SHEET_NAME, "sale", nonce)
elif st.session_state.dataset == "rent":
    df, source_kind = load_sheet(RENT_SHEET_NAME, "rent", nonce)
else:
    st.stop()

data = df[df["ê³µê°œì—¬ë¶€_norm"] == "y"].copy()

# ë°ì´í„° ì§„ë‹¨
with st.expander("ğŸ§ª ë°ì´í„° ì§„ë‹¨(ì›ë³¸ í™•ì¸)"):
    st.write(f"ì†ŒìŠ¤: {source_kind} | í–‰ìˆ˜: {len(df):,}")
    st.write("ì»¬ëŸ¼:", list(df.columns))
    st.dataframe(df.head(15), use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) ë‹¨ê³„í˜• ë„¤ë¹„ (ë‘ ë²ˆì§¸ ë‹¨ê³„)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.container():
    if st.session_state.mode is None:
        if st.session_state.dataset == "sale":
            st.subheader("ê²€ìƒ‰ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” (ë§¤ë§¤)")
            c1, c2, c3 = st.columns(3)
            with c1:
                if st.button("ğŸ’° ê¸ˆì•¡ëŒ€ë³„ ê²€ìƒ‰", use_container_width=True): select_mode("price_sale")
            with c2:
                if st.button("ğŸ—ºï¸ êµ¬ì—­ë³„ ê²€ìƒ‰", use_container_width=True): select_mode("zone_sale")
            with c3:
                if st.button("ğŸ“ í‰í˜•ëŒ€ë³„ ê²€ìƒ‰", use_container_width=True): select_mode("pyeong_sale")
        else:
            st.subheader("ê²€ìƒ‰ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” (ì„ëŒ€)")
            c1, c2, c3 = st.columns(3)
            with c1:
                if st.button("ğŸ’µ ê¸ˆì•¡ë³„ ê²€ìƒ‰(ì „ì„¸/ë³´ì¦ê¸ˆ)", use_container_width=True): select_mode("amount_rent")
            with c2:
                if st.button("ğŸ—ºï¸ êµ¬ì—­ë³„ ê²€ìƒ‰", use_container_width=True): select_mode("zone_rent")
            with c3:
                if st.button("ğŸ“ í‰í˜•ëŒ€ë³„ ê²€ìƒ‰", use_container_width=True): select_mode("pyeong_rent")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) ì¶œë ¥ ë„êµ¬ (ê³µí†µ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def paginate(dfv: pd.DataFrame):
    if page_size_label == "ì „ì²´":
        return dfv, 1, 1
    ps = int(page_size_label)
    total = max(1, int(np.ceil(len(dfv)/ps)))
    page = max(1, min(st.session_state.page, total))
    start = (page-1)*ps
    end = start + ps
    return dfv.iloc[start:end], page, total

def show_cards_sale(dfv: pd.DataFrame):
    for _, r in dfv.iterrows():
        title = f"**{r['êµ¬ì—­']} Â· {r['í‰í˜•']} Â· {r['ë™']}ë™ {r['ì¸µ']}ì¸µ**"
        price = "â€”" if pd.isna(r["ê¸ˆì•¡(ì–µ)"]) else f"**{float(r['ê¸ˆì•¡(ì–µ)']):.1f}ì–µ**"
        summary = str(r["ìš”ì•½ë‚´ìš©"])
        short = (summary[:40] + "â€¦") if len(summary) > 40 else summary
        st.markdown(f"{title}  \n{price} â€” {short}")
        st.divider()

def show_cards_rent(dfv: pd.DataFrame):
    for _, r in dfv.iterrows():
        title = f"**{r['êµ¬ì—­']} Â· {r['í‰í˜•']} Â· {r['ë™']}ë™ {r['ì¸µ']}ì¸µ**"
        has_jeonse = not pd.isna(r.get("ê¸ˆì•¡(ì–µ)", np.nan))
        has_depo   = not pd.isna(r.get("ë³´ì¦ê¸ˆ(ì–µ)", np.nan))
        if has_jeonse:
            price = f"**(ì „ì„¸)** {float(r['ê¸ˆì•¡(ì–µ)']):.1f}(ì–µ)"
        elif has_depo:
            parts = [f"ë³´ì¦ê¸ˆ {float(r['ë³´ì¦ê¸ˆ(ì–µ)']):.1f}(ì–µ)"]
            wol = r.get("ì›”ì„¸(ë§Œ)", np.nan)
            if not pd.isna(wol) and float(wol) != 0:
                parts.append(f"ì›” {int(float(wol))}(ë§Œ)")
            price = f"**(ì›”ì„¸)** " + " / ".join(parts)
        else:
            price = ""
        summary = str(r["ìš”ì•½ë‚´ìš©"])
        short = (summary[:40] + "â€¦") if len(summary) > 40 else summary
        st.markdown(f"{title}  \n{price} â€” {short}")
        st.divider()

def show_table_sale(dfv: pd.DataFrame):
    try:
        st.dataframe(
            dfv, use_container_width=True, hide_index=True,
            column_config={
                "í‰í˜•ëŒ€":  st.column_config.TextColumn("í‰í˜•ëŒ€",  width="small"),
                "êµ¬ì—­":    st.column_config.TextColumn("êµ¬ì—­",    width="small"),
                "í‰í˜•":    st.column_config.TextColumn("í‰í˜•",    width="small"),
                "ë™":      st.column_config.TextColumn("ë™",      width="small"),
                "ì¸µ":      st.column_config.TextColumn("ì¸µ",      width="small"),
                "ê¸ˆì•¡(ì–µ)": st.column_config.NumberColumn("ê¸ˆì•¡(ì–µ)", width="small", format="%.1f"),
                "ìš”ì•½ë‚´ìš©": st.column_config.TextColumn("ìš”ì•½ë‚´ìš©", width="medium", max_chars=60),
            }
        )
    except Exception:
        st.dataframe(dfv, use_container_width=True)

def show_table_rent(dfv: pd.DataFrame):
    dfv = dfv.copy()
    dfv["ì „ì„¸ê¸ˆ(í‘œì‹œ)"] = dfv["ê¸ˆì•¡(ì–µ)"].apply(lambda x: "" if pd.isna(x) else f"{float(x):.1f}(ì–µ)")
    dfv["ë³´ì¦ê¸ˆ(í‘œì‹œ)"] = dfv["ë³´ì¦ê¸ˆ(ì–µ)"].apply(lambda x: "" if pd.isna(x) else f"{float(x):.1f}(ì–µ)")
    def fmt_wol(x):
        if pd.isna(x) or float(x) == 0: return ""
        try: return f"{int(float(x))}(ë§Œ)"
        except: return ""
    dfv["ì›”ì„¸(í‘œì‹œ)"] = dfv["ì›”ì„¸(ë§Œ)"].apply(fmt_wol)
    cols = ["í‰í˜•ëŒ€","êµ¬ì—­","í‰í˜•","ë™","ì¸µ","ì „ì„¸ê¸ˆ(í‘œì‹œ)","ë³´ì¦ê¸ˆ(í‘œì‹œ)","ì›”ì„¸(í‘œì‹œ)","ìš”ì•½ë‚´ìš©"]
    try:
        st.dataframe(
            dfv[cols], use_container_width=True, hide_index=True,
            column_config={
                "í‰í˜•ëŒ€":  st.column_config.TextColumn("í‰í˜•ëŒ€",  width="small"),
                "êµ¬ì—­":    st.column_config.TextColumn("êµ¬ì—­",    width="small"),
                "í‰í˜•":    st.column_config.TextColumn("í‰í˜•",    width="small"),
                "ë™":      st.column_config.TextColumn("ë™",      width="small"),
                "ì¸µ":      st.column_config.TextColumn("ì¸µ",      width="small"),
                "ì „ì„¸ê¸ˆ(í‘œì‹œ)": st.column_config.TextColumn("ì „ì„¸ê¸ˆ", width="small"),
                "ë³´ì¦ê¸ˆ(í‘œì‹œ)": st.column_config.TextColumn("ë³´ì¦ê¸ˆ", width="small"),
                "ì›”ì„¸(í‘œì‹œ)":   st.column_config.TextColumn("ì›”ì„¸",   width="small"),
                "ìš”ì•½ë‚´ìš©": st.column_config.TextColumn("ìš”ì•½ë‚´ìš©", width="medium", max_chars=60),
            }
        )
    except Exception:
        st.dataframe(dfv[cols], use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) ê²€ìƒ‰/í•„í„° ë¡œì§ â€” í‰í˜•ëŒ€ëŠ” ì‹œíŠ¸ê°’ ê·¸ëŒ€ë¡œ í•„í„°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SALE_DISPLAY = ["í‰í˜•ëŒ€","êµ¬ì—­","í‰í˜•","ë™","ì¸µ","ê¸ˆì•¡(ì–µ)","ìš”ì•½ë‚´ìš©"]
RENT_EXPORT  = ["í‰í˜•ëŒ€","êµ¬ì—­","í‰í˜•","ë™","ì¸µ","ê¸ˆì•¡(ì–µ)","ë³´ì¦ê¸ˆ(ì–µ)","ì›”ì„¸(ë§Œ)","ìš”ì•½ë‚´ìš©"]

# ì‹œíŠ¸ í‘œì¤€ ì¹´í…Œê³ ë¦¬
BAND_ORDER = ["20í‰í˜•ëŒ€","30í‰í˜•ëŒ€","40í‰í˜•ëŒ€","50í‰í˜•ëŒ€","60í‰í˜•ëŒ€","70í‰í˜•ëŒ€","80í‰í˜•ëŒ€"]

out = pd.DataFrame()

# ë§¤ë§¤
if st.session_state.mode == "price_sale":
    st.subheader("ğŸ’° ê¸ˆì•¡ëŒ€ë³„ ê²€ìƒ‰ (ë§¤ë§¤)")
    v = pd.to_numeric(data["ê¸ˆì•¡(ì–µ)"], errors="coerce").dropna()
    min_eok, max_eok = (0.0, 100.0) if v.empty else (float(np.floor(v.min())), float(np.ceil(v.max())))
    c1, c2, c3 = st.columns([1,1,1])
    with c1:
        min_in = st.number_input("ìµœì†Œ(ì–µ)", min_value=0.0, max_value=max_eok, value=min_eok, step=0.1, format="%.1f")
    with c2:
        max_in = st.number_input("ìµœëŒ€(ì–µ)", min_value=min_in, max_value=max_eok, value=max_eok, step=0.1, format="%.1f")
    with c3:
        run = st.button("ì¡°íšŒ", type="primary", use_container_width=True)
    if run:
        q = data[pd.to_numeric(data["ê¸ˆì•¡(ì–µ)"], errors="coerce").between(min_in, max_in)]
        out = q[SALE_DISPLAY].copy()
        out["ê¸ˆì•¡(ì–µ)"] = pd.to_numeric(out["ê¸ˆì•¡(ì–µ)"], errors="coerce")
        out = out.sort_values(by="ê¸ˆì•¡(ì–µ)", ascending=True, na_position="last")
        st.session_state.results_ready = True

elif st.session_state.mode == "zone_sale":
    st.subheader("ğŸ—ºï¸ êµ¬ì—­ë³„ ê²€ìƒ‰ (ë§¤ë§¤)")
    zones = ["1êµ¬ì—­","2êµ¬ì—­","3êµ¬ì—­","4êµ¬ì—­","5êµ¬ì—­","6êµ¬ì—­"]
    c1, c2 = st.columns([2,1])
    with c1:
        zone = st.selectbox("êµ¬ì—­", zones, index=0)
    with c2:
        run = st.button("ì¡°íšŒ", type="primary", use_container_width=True)
    if run:
        q = data[data["êµ¬ì—­"].astype(str) == zone]
        out = q[SALE_DISPLAY].copy()
        out["ê¸ˆì•¡(ì–µ)"] = pd.to_numeric(out["ê¸ˆì•¡(ì–µ)"], errors="coerce")
        out = out.sort_values(by="ê¸ˆì•¡(ì–µ)", ascending=True, na_position="last")
        st.session_state.results_ready = True

elif st.session_state.mode == "pyeong_sale":
    st.subheader("ğŸ“ í‰í˜•ëŒ€ë³„ ê²€ìƒ‰ (ë§¤ë§¤)")
    c1, c2 = st.columns([2,1])
    with c1:
        band = st.selectbox("í‰í˜•ëŒ€", BAND_ORDER, index=2)  # 40í‰í˜•ëŒ€ ê¸°ë³¸ ì„ íƒ ê°€ëŠ¥
    with c2:
        run = st.button("ì¡°íšŒ", type="primary", use_container_width=True)
    if run:
        q = data[data["í‰í˜•ëŒ€"].astype(str).str.replace(" ", "") == band]
        out = q[SALE_DISPLAY].copy()
        out["ê¸ˆì•¡(ì–µ)"] = pd.to_numeric(out["ê¸ˆì•¡(ì–µ)"], errors="coerce")
        out = out.sort_values(by="ê¸ˆì•¡(ì–µ)", ascending=True, na_position="last")
        st.session_state.results_ready = True

# ì„ëŒ€
elif st.session_state.mode == "amount_rent":
    st.subheader("ğŸ’µ ê¸ˆì•¡ë³„ ê²€ìƒ‰ (ì„ëŒ€: ì „ì„¸ â€˜ê¸ˆì•¡(ì–µ)â€™ + ì›”ì„¸ â€˜ë³´ì¦ê¸ˆ(ì–µ)â€™ ëª¨ë‘ í¬í•¨)")
    v_j = pd.to_numeric(data["ê¸ˆì•¡(ì–µ)"], errors="coerce")
    v_d = pd.to_numeric(data["ë³´ì¦ê¸ˆ(ì–µ)"], errors="coerce")
    base = pd.concat([v_j.dropna(), v_d.dropna()])
    min_eok, max_eok = (0.0, 50.0) if base.empty else (float(np.floor(base.min())), float(np.ceil(base.max())))
    c1, c2, c3 = st.columns([1,1,1])
    with c1:
        min_in = st.number_input("ìµœì†Œ(ì–µ)", min_value=0.0, max_value=max_eok, value=min_eok, step=0.1, format="%.1f")
    with c2:
        max_in = st.number_input("ìµœëŒ€(ì–µ)", min_value=min_in, max_value=max_eok, value=max_eok, step=0.1, format="%.1f")
    with c3:
        run = st.button("ì¡°íšŒ", type="primary", use_container_width=True)
    if run:
        m = (v_j.between(min_in, max_in, inclusive="both")) | (v_d.between(min_in, max_in, inclusive="both"))
        q = data[m].copy()
        # ì •ë ¬í‚¤: ì „ì„¸ê¸ˆ(ì–µ) ìš°ì„ , ì—†ìœ¼ë©´ ë³´ì¦ê¸ˆ(ì–µ)
        sort_key = v_j.where(~v_j.isna(), v_d).loc[q.index]
        q["_ì •ë ¬ì•¡"] = sort_key
        q["ì›”ì„¸(ë§Œ)"] = pd.to_numeric(q["ì›”ì„¸(ë§Œ)"], errors="coerce")
        q = q.sort_values(by=["_ì •ë ¬ì•¡","ì›”ì„¸(ë§Œ)"], ascending=[True, True], na_position="last")
        out = q[RENT_EXPORT].copy()
        st.session_state.results_ready = True

elif st.session_state.mode == "zone_rent":
    st.subheader("ğŸ—ºï¸ êµ¬ì—­ë³„ ê²€ìƒ‰ (ì„ëŒ€)")
    zones = ["1êµ¬ì—­","2êµ¬ì—­","3êµ¬ì—­","4êµ¬ì—­","5êµ¬ì—­","6êµ¬ì—­"]
    c1, c2 = st.columns([2,1])
    with c1:
        zone = st.selectbox("êµ¬ì—­", zones, index=0)
    with c2:
        run = st.button("ì¡°íšŒ", type="primary", use_container_width=True)
    if run:
        q = data[data["êµ¬ì—­"].astype(str) == zone].copy()
        q["_ì •ë ¬ì•¡"] = pd.to_numeric(q["ê¸ˆì•¡(ì–µ)"], errors="coerce").where(
            ~pd.to_numeric(q["ê¸ˆì•¡(ì–µ)"], errors="coerce").isna(),
            pd.to_numeric(q["ë³´ì¦ê¸ˆ(ì–µ)"], errors="coerce")
        )
        q["ì›”ì„¸(ë§Œ)"] = pd.to_numeric(q["ì›”ì„¸(ë§Œ)"], errors="coerce")
        q = q.sort_values(by=["_ì •ë ¬ì•¡","ì›”ì„¸(ë§Œ)"], ascending=[True, True], na_position="last")
        out = q[RENT_EXPORT].copy()
        st.session_state.results_ready = True

elif st.session_state.mode == "pyeong_rent":
    st.subheader("ğŸ“ í‰í˜•ëŒ€ë³„ ê²€ìƒ‰ (ì„ëŒ€)")
    c1, c2 = st.columns([2,1])
    with c1:
        band = st.selectbox("í‰í˜•ëŒ€", BAND_ORDER, index=2)
    with c2:
        run = st.button("ì¡°íšŒ", type="primary", use_container_width=True)
    if run:
        q = data[data["í‰í˜•ëŒ€"].astype(str).str.replace(" ", "") == band].copy()
        q["_ì •ë ¬ì•¡"] = pd.to_numeric(q["ê¸ˆì•¡(ì–µ)"], errors="coerce").where(
            ~pd.to_numeric(q["ê¸ˆì•¡(ì–µ)"], errors="coerce").isna(),
            pd.to_numeric(q["ë³´ì¦ê¸ˆ(ì–µ)"], errors="coerce")
        )
        q["ì›”ì„¸(ë§Œ)"] = pd.to_numeric(q["ì›”ì„¸(ë§Œ)"], errors="coerce")
        q = q.sort_values(by=["_ì •ë ¬ì•¡","ì›”ì„¸(ë§Œ)"], ascending=[True, True], na_position="last")
        out = q[RENT_EXPORT].copy()
        st.session_state.results_ready = True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7) ê²°ê³¼ ì¶œë ¥ + í˜ì´ì§€ + ë‹¤ìš´ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
st.caption(f"ë°ì´í„° ì†ŒìŠ¤: {source_kind}")

if st.session_state.results_ready:
    st.markdown("### ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼")
    st.caption(f"ì´ {len(out):,}ê±´ (ê³µê°œì—¬ë¶€=Y)")
    if len(out) == 0:
        st.info("ì¡°ê±´ì— ë§ëŠ” ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. ë²”ìœ„ë¥¼ ë„“í˜€ ë‹¤ì‹œ ì¡°íšŒí•´ ë³´ì„¸ìš”.")
    else:
        # í˜ì´ì§€ë„¤ì´ì…˜
        def _paginate(dfv: pd.DataFrame):
            if page_size_label == "ì „ì²´":
                return dfv, 1, 1
            ps = int(page_size_label)
            total = max(1, int(np.ceil(len(dfv)/ps)))
            page = max(1, min(st.session_state.page, total))
            start = (page-1)*ps
            end = start + ps
            return dfv.iloc[start:end], page, total

        view_df, cur, total = _paginate(out)

        if st.session_state.dataset == "sale":
            if view_mode.startswith("ëª¨ë°”ì¼"):
                show_cards_sale(view_df)
            else:
                show_table_sale(view_df)
        else:
            if view_mode.startswith("ëª¨ë°”ì¼"):
                show_cards_rent(view_df)
            else:
                show_table_rent(view_df)

        if page_size_label != "ì „ì²´" and total > 1:
            colp1, colp2, colp3 = st.columns([1,1,1])
            with colp1:
                if st.button("â¬…ï¸ ì´ì „", use_container_width=True) and st.session_state.page > 1:
                    st.session_state.page -= 1
                    st.experimental_rerun()
            with colp2:
                st.write(f"í˜ì´ì§€ {cur} / {total}")
            with colp3:
                if st.button("ë‹¤ìŒ â¡ï¸", use_container_width=True) and st.session_state.page < total:
                    st.session_state.page += 1
                    st.experimental_rerun()

        # ë‹¤ìš´ë¡œë“œ
        csv_bytes = out.to_csv(index=False).encode("utf-8-sig")
        fname_prefix = "ë§¤ë§¤" if st.session_state.dataset == "sale" else "ì„ëŒ€"
        st.download_button(
            "â¬‡ï¸ ì „ì²´ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ",
            data=csv_bytes,
            file_name=f"ì••êµ¬ì •ë™_{fname_prefix}_{st.session_state.mode}_ê²€ìƒ‰_{datetime.now():%Y%m%d_%H%M}.csv",
            mime="text/csv",
            use_container_width=True
        )
